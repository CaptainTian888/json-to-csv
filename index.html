<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Az Captain Json to CSV</title>
  <link rel="icon" type="image/png" href="https://imgbed.captainzeqi.com/file/1758348585439_黑白路飞透明背景.png">
  <style>
    :root {
      --bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;
      --accent:#06b6d4;--accent-2:#7c3aed;--highlight:#ffd54f;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      margin:0;min-height:100vh;
      background:linear-gradient(180deg,#071124 0%, #081227 60%);
      color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:28px
    }
    .wrap{width:100%;max-width:980px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));
      border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:12px;
      box-shadow:0 6px 18px rgba(2,6,23,0.6)
    }
    .drop{
      border:2px dashed rgba(255,255,255,0.08);padding:40px;border-radius:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;
      transition:all 0.3s ease
    }
    .drop.drag{
      background:linear-gradient(90deg,rgba(6,182,212,0.1),rgba(124,58,237,0.1));
      border-color:rgba(6,182,212,0.5)
    }
    .drop strong{font-size:16px}
    .fileinfo{font-size:13px;color:var(--muted)}
    .result{margin-top:14px;display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
    .stat{background:rgba(255,255,255,0.02);padding:10px 16px;border-radius:8px;font-size:14px}
    .download{display:inline-flex;align-items:center;gap:8px}
    button{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#04212a;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;
      font-weight:600;transition:opacity .2s
    }
    button:hover{opacity:0.9}
    table{
      width:100%;border-collapse:collapse;margin-top:14px;font-size:13px;table-layout:fixed;
    }
    thead th{
      background:rgba(0,0,0,0.25);padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);
    }
    tbody td{
      padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,0.02);color:#dbe8f2;word-wrap:break-word;
    }
    tbody tr:hover{background:rgba(255,255,255,0.05)}
    footer{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
    .copyright{margin-top:8px;font-size:12px;color:var(--muted);text-align:center}

    /* 全屏浮层 */
    .overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(4,6,15,0.97); backdrop-filter:blur(8px);
      display:none; flex-direction:column; z-index:9999; overflow:hidden;
      animation:fadeIn .3s ease;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .overlay-header {
      flex:0 0 auto; padding:14px 24px; background:rgba(255,255,255,0.06);
      display:flex; align-items:center; justify-content:space-between;
      font-size:16px; border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .overlay-header button{
      background:transparent;border:0;color:var(--accent);
      font-size:18px;cursor:pointer;font-weight:bold;
    }
    .overlay-content{
      flex:1;overflow-y:auto;overflow-x:hidden;padding:16px 24px;
      scrollbar-width:thin;scrollbar-color:var(--accent) rgba(255,255,255,0.1);
    }
    .copy-btn{
      background:rgba(6,182,212,0.1); border:1px solid rgba(6,182,212,0.4);
      color:var(--accent); font-size:12px; padding:4px 6px; border-radius:6px;
      cursor:pointer; margin-left:6px; transition:all .2s;
    }
    .copy-btn:hover{background:rgba(6,182,212,0.25)}
    .open-link{color:var(--accent); text-decoration:none;word-break:break-all;}
    .open-link:hover{text-decoration:underline}
    .search-bar{
      background:rgba(255,255,255,0.08); padding:8px 14px; border-radius:8px;
      border:none; color:#fff; width:260px; outline:none; font-size:14px;
    }
    mark{
      background:var(--highlight);
      color:#000;
      padding:0 2px;
      border-radius:3px;
    }
  </style>
  <!-- ✅ 引入 SheetJS 库（用于生成 Excel） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://imgbed.captainzeqi.com/file/1758348585439_黑白路飞透明背景.png" alt="logo" style="width:42px;height:42px;border-radius:8px;object-fit:contain;">
      <div>
        <h1>Az Captain Json to CSV</h1>
        <p class="lead">将 JSON 文件直接拖入下方区域，系统将自动提取网站信息并生成 CSV / Excel 文件。</p>
      </div>
    </header>

    <section class="card">
      <div id="drop" class="drop">
        <strong>拖入你的 JSON 文件到此处</strong>
        <div class="fileinfo">支持 .json 文件（大小不限）</div>
      </div>

      <div class="result">
        <div class="stat">已提取网站数： <strong id="count">0</strong></div>
        <div class="stat">生成的文件名： <span id="outname">-</span></div>
        <div class="download" id="downloadWrap" style="display:none">
          <a id="downloadLink" href="#" download style="text-decoration:none"><button>下载 CSV</button></a>
          <!-- ✅ 新增 Excel 下载按钮 -->
          <button id="downloadExcel">下载 Excel</button>
          <button id="fullPreview">全屏预览全部</button>
        </div>
      </div>

      <footer>
        提示：如果 CSV 在 Excel 打开出现乱码，使用 "UTF-8 带 BOM"（本工具已自动处理）。
        <div class="copyright">© 2025 Az Captain</div>
      </footer>
    </section>
  </div>

  <!-- 全屏预览浮层 -->
  <div id="overlay" class="overlay">
    <div class="overlay-header">
      <div id="overlayTitle">网站数据预览</div>
      <div style="display:flex;align-items:center;gap:12px;">
        <input type="text" id="searchInput" class="search-bar" placeholder="🔍 输入关键词查找...">
        <button id="closeOverlay">✕</button>
      </div>
    </div>
    <div class="overlay-content" id="overlayContent"></div>
  </div>

  <script>
    function extractSitesFromNode(node, results, breadcrumbPrefix = []){
      if (!node) return;
      if (Array.isArray(node)){
        node.forEach(n => extractSitesFromNode(n, results, breadcrumbPrefix));
        return;
      }
      if (node.nav && Array.isArray(node.nav)){
        const title = node.title || node.name || null;
        const newPrefix = breadcrumbPrefix.slice();
        if (title) newPrefix.push(title);
        node.nav.forEach(child => extractSitesFromNode(child, results, newPrefix));
        return;
      }
      if (node.url){
        let breadcrumb = node.breadcrumb && Array.isArray(node.breadcrumb) ? node.breadcrumb : breadcrumbPrefix;
        const one = breadcrumb[0] || "";
        const two = breadcrumb[1] || "";
        const three = breadcrumb[2] || "";
        results.push({
          一级分类: one,
          二级分类: two,
          三级分类: three,
          网站名称: node.name || node.title || "",
          网站地址: node.url || "",
          网站描述: node.desc || node.description || "",
          网站图标地址: node.icon || node.favicon || ""
        });
        return;
      }
      if (typeof node === 'object'){
        Object.values(node).forEach(v => {
          if (Array.isArray(v) || typeof v === 'object') extractSitesFromNode(v, results, breadcrumbPrefix);
        });
      }
    }

    function jsonToRows(obj){
      const results = [];
      if (obj && obj.db && Array.isArray(obj.db)){
        obj.db.forEach(section => {
          if (section.nav) extractSitesFromNode(section.nav, results);
          else extractSitesFromNode(section, results);
        });
      } else {
        extractSitesFromNode(obj, results);
      }
      return results;
    }

    function rowsToCsv(rows){
      const headers = ["一级分类","二级分类","三级分类","网站名称","网站地址","网站描述","网站图标地址"];
      const escape = v => {
        if (v === null || v === undefined) return '';
        v = String(v);
        if (v.indexOf('"') !== -1) v = v.replace(/"/g, '""');
        if (/[",\n]/.test(v)) return '"'+v+'"';
        return v;
      }
      const lines = [headers.join(',')];
      for (const r of rows){
        const line = headers.map(h => escape(r[h] || '')).join(',');
        lines.push(line);
      }
      return '\uFEFF' + lines.join('\n');
    }

    const dropEl = document.getElementById('drop');
    const countEl = document.getElementById('count');
    const downloadWrap = document.getElementById('downloadWrap');
    const downloadLink = document.getElementById('downloadLink');
    const outnameEl = document.getElementById('outname');
    const fullPreviewBtn = document.getElementById('fullPreview');
    const downloadExcelBtn = document.getElementById('downloadExcel'); // ✅ 新增按钮引用
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayContent = document.getElementById('overlayContent');
    const closeOverlay = document.getElementById('closeOverlay');
    const searchInput = document.getElementById('searchInput');

    let lastCsvBlobUrl = null;
    let lastRows = [];
    let lastFilename = "output.csv";

    function processFile(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          lastRows = jsonToRows(data);
          countEl.textContent = lastRows.length;
          const csv = rowsToCsv(lastRows);
          const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
          if (lastCsvBlobUrl){ URL.revokeObjectURL(lastCsvBlobUrl); }
          lastCsvBlobUrl = URL.createObjectURL(blob);
          const outname = file.name.replace(/\.json$/i,'')+'.csv';
          lastFilename = outname;
          downloadLink.href = lastCsvBlobUrl;
          downloadLink.download = outname;
          outnameEl.textContent = outname;
          downloadWrap.style.display = 'inline-flex';
          alert('转换完成：共提取 ' + lastRows.length + ' 条记录。');
        }catch(err){ alert('解析失败：'+err.message); }
      }
      reader.readAsText(file,'utf-8');
    }

    dropEl.addEventListener('dragover', e=>{ e.preventDefault(); dropEl.classList.add('drag'); });
    dropEl.addEventListener('dragleave', e=> dropEl.classList.remove('drag'));
    dropEl.addEventListener('drop', e=>{
      e.preventDefault(); dropEl.classList.remove('drag');
      const f = e.dataTransfer.files[0];
      if (f) processFile(f);
    });

    // ✅ 下载 Excel 功能
    downloadExcelBtn.addEventListener('click', ()=>{
      if (!lastRows.length) return alert('请先导入 JSON 文件！');
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(lastRows);

      // 自动调整列宽
      const headers = Object.keys(lastRows[0]);
      const colWidths = headers.map(h=>{
        const maxLen = Math.max(
          h.length,
          ...lastRows.map(r=>String(r[h]||'').length)
        );
        return { wch: Math.min(maxLen + 4, 60) }; // 限制最大宽度 60
      });
      ws['!cols'] = colWidths;

      XLSX.utils.book_append_sheet(wb, ws, '数据');
      const outname = lastFilename.replace(/\.csv$/i,'.xlsx');
      XLSX.writeFile(wb, outname);
    });

    fullPreviewBtn.addEventListener('click', ()=>{ overlay.style.display = 'flex'; renderTable(lastRows); });
    closeOverlay.addEventListener('click', ()=> overlay.style.display = 'none');

    function highlightText(text, query){
      if (!query) return escapeHtml(text);
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
      return escapeHtml(text).replace(regex, '<mark>$1</mark>');
    }

    function renderTable(rows, query=''){
      overlayTitle.textContent = `网站数据预览（共 ${rows.length} 条）`;
      const head = ['一级分类','二级分类','三级分类','网站名称','网站地址','网站描述','网站图标地址'];
      let html = '<table><thead><tr>' + head.map(h => '<th>'+h+'</th>').join('') + '</tr></thead><tbody>';
      for (const r of rows){
        html += `<tr>
          <td>${highlightText(r['一级分类']||'',query)}</td>
          <td>${highlightText(r['二级分类']||'',query)}</td>
          <td>${highlightText(r['三级分类']||'',query)}</td>
          <td>${highlightText(r['网站名称']||'',query)} <button class="copy-btn" onclick="copyText('${escapeJs(r['网站名称'])}')">📋</button></td>
          <td><a href="${escapeHtml(r['网站地址'])}" class="open-link" target="_blank">${highlightText(r['网站地址']||'',query)}</a> <button class="copy-btn" onclick="copyText('${escapeJs(r['网站地址'])}')">📋</button></td>
          <td>${highlightText(r['网站描述']||'',query)} <button class="copy-btn" onclick="copyText('${escapeJs(r['网站描述'])}')">📋</button></td>
          <td>${highlightText(r['网站图标地址']||'',query)} <button class="copy-btn" onclick="copyText('${escapeJs(r['网站图标地址'])}')">📋</button></td>
        </tr>`;
      }
      html += '</tbody></table>';
      overlayContent.innerHTML = html;
    }

    searchInput.addEventListener('input', e=>{
      const q = e.target.value.trim();
      const filtered = !q ? lastRows :
        lastRows.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q.toLowerCase())));
      renderTable(filtered, q);
    });

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function escapeJs(s){ return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }
    function copyText(text){
      navigator.clipboard.writeText(text).then(()=>{
        const btn = event.target;
        btn.textContent = "✅";
        setTimeout(()=>btn.textContent="📋",800);
      });
    }
  </script>
</body>
</html>
